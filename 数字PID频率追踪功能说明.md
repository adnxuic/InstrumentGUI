# 数字PID频率追踪功能说明

## 概述

数字PID频率追踪功能通过程序控制WF1947信号发生器的输出频率，使其自动跟踪系统的共振频率变化。系统使用SR830锁相放大器测量输入输出信号的相位差，通过数字PID算法调整WF1947的频率，使相位差维持在设定值（通常为0°），从而实现共振频率追踪。

## 系统组成

### 硬件设备

- **WF1947信号发生器**: 提供激励信号，频率可程控调节
- **SR830锁相放大器**: 测量系统响应，特别是相位信息
- **被测系统**: 具有共振特性的物理系统

### 软件模块

- **PID.py**: 数字PID算法实现和频率追踪线程
- **digitalPID.py**: 用户界面控制面板
- **plot_canves.py**: 实时数据可视化
- **datasort.py**: 数据保存功能

## 工作原理

### 1. 系统模型

```
WF1947(频率f) → 被测系统 → SR830(测相位φ)
              ↑                    ↓
            PID控制器 ← ← ← ← ← 相位误差
```

### 2. PID控制算法

- **输入**: 当前相位φ（从SR830读取）
- **设定值**: 目标相位φ_target（通常为0°）
- **误差**: e = φ_target - φ
- **输出**: 频率调整量Δf

PID输出计算：

```
u(t) = Kp·e(t) + Ki·∫e(t)dt + Kd·de(t)/dt
```

### 3. 频率更新

```
f_new = f_current + u(t) × Δt
```

## 使用方法

### 1. 参数设置

#### PID参数

- **Kp (比例系数)**: 控制响应速度，建议值: 1.0-5.0
- **Ki (积分系数)**: 消除稳态误差，建议值: 0.1-1.0
- **Kd (微分系数)**: 改善动态性能，建议值: 0.01-0.1

#### 目标设置

- **目标相位**: 期望的相位差，通常设为0°

#### 追踪设置

- **采样间隔**: PID控制周期，建议值: 0.05-0.2秒

### 2. 操作步骤

1. **连接仪器**

   - 确保WF1947和SR830正确连接并可通信
   - 验证仪器地址配置正确
2. **设置参数**

   ```
   建议初始参数：
   - Kp: 2.0
   - Ki: 0.5  
   - Kd: 0.1
   - 目标相位: 0°
   - 采样间隔: 0.1s
   ```
3. **开始追踪**

   - 点击"开始跟踪"按钮
   - 观察实时图表中的频率和相位变化
   - 监控状态信息
4. **调整参数**（如需要）

   - 如果响应太慢：增加Kp
   - 如果有震荡：减少Kp或Kd
   - 如果有稳态误差：增加Ki
5. **停止和保存**

   - 点击"停止跟踪"结束追踪
   - 自动保存（如已启用）或手动保存数据

### 3. 图表说明

#### 频率图表

- **蓝色实线**: WF1947输出频率随时间变化
- 显示PID控制器如何调整频率以跟踪共振

#### 相位图表

- **红色实线**: SR830测量的实际相位
- **绿色虚线**: 目标相位（设定值）
- 理想情况下红线应趋近于绿线

## 数据保存

### 自动保存

- 追踪完成后自动保存到 `history_data/`目录
- 文件名格式: `frequency_tracking_YYYYMMDD_HHMMSS.dat`

### 手动保存

- 点击"手动保存"按钮
- 可选择保存位置和文件名

### 数据格式

保存的数据包含以下列：

- `time`: 相对时间（秒）
- `frequency`: WF1947输出频率（Hz）
- `phase`: SR830测量相位（度）
- `setpoint`: 目标相位（度）
- `error`: 相位误差（度）
- `pid_output`: PID输出（Hz/s）
- `proportional`: 比例项
- `integral`: 积分项
- `derivative`: 微分项

## 故障排除

### 常见问题

1. **"未找到仪器"错误**

   - 检查仪器连接和电源
   - 验证VISA地址配置
   - 确认驱动程序已安装
2. **频率不收敛**

   - 检查PID参数设置
   - 确认目标相位设置合理
   - 验证系统确实存在共振特性
3. **频率震荡**

   - 减少Kp值
   - 减少Kd值
   - 增加采样间隔
4. **响应太慢**

   - 增加Kp值
   - 适当增加Ki值
   - 减少采样间隔

### 参数调节指南

| 现象     | 可能原因 | 建议调整   |
| -------- | -------- | ---------- |
| 无响应   | Kp太小   | 增加Kp     |
| 震荡     | Kp太大   | 减少Kp     |
| 稳态误差 | Ki太小   | 增加Ki     |
| 过冲     | Kd太小   | 适当增加Kd |
| 噪声敏感 | Kd太大   | 减少Kd     |

## 测试功能

运行测试脚本验证功能：

```bash
python src/instruments/test/digital_pid_test.py
```

测试脚本提供：

- 模拟的WF1947和SR830仪器
- 可调节的共振频率漂移
- 完整的GUI界面测试

## 技术特点

### 优势

- **实时控制**: 100ms级别的响应速度
- **自动追踪**: 无需人工干预
- **数据记录**: 完整的过程数据保存
- **可视化**: 实时图表显示
- **参数可调**: 灵活的PID参数设置

### 适用场景

- 温度变化导致的共振频率漂移
- 机械振动系统的频率追踪
- 电路谐振特性的实时监控
- 材料特性测试中的频率扫描

## 注意事项

1. **频率范围**: 确保在WF1947的工作范围内（0.1Hz-30MHz）
2. **采样率**: 避免过高的采样率导致系统不稳定
3. **积分饱和**: 长时间运行时注意积分项累积
4. **数据量**: 长时间记录会产生大量数据文件
5. **仪器保护**: 避免频率变化过快损坏设备
